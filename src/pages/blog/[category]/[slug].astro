---
import Layout from "../../../layouts/Layout.astro";
import { sanityFetch, queries } from "@/lib/sanity";
import { safeAsync } from "@/utils/errorHandling";
import { isAuthenticated } from "@/lib/auth";
import { PortableText } from "astro-portabletext";
import type { BlogPost } from "@/types/sanity";

// Disable prerendering
export const prerender = false;

// Get params
const { category, slug } = Astro.params;

// Fetch blog post
const post = await safeAsync(
    () =>
        sanityFetch<BlogPost | null>(queries.blogPostBySlug, {
            slug,
            categorySlug: category,
        }),
    null,
);

// If post doesn't exist, return 404
if (!post) {
    return Astro.redirect("/404");
}

// Check if category is protected and redirect to login if not authenticated
if (post.category.isProtected) {
    if (!isAuthenticated(Astro.cookies, category as string)) {
        return Astro.redirect(`/blog/${category}/login`);
    }
}

// Format date helper
function formatDate(dateString: string): string {
    return new Date(dateString).toLocaleDateString("fr-FR", {
        year: "numeric",
        month: "long",
        day: "numeric",
    });
}

// Get image URL from Sanity
function getImageUrl(image: any): string | null {
    if (!image?.asset?._ref) return null;
    return `https://cdn.sanity.io/images/9bdbnjzy/production/${image.asset._ref.replace("image-", "").replace("-jpg", ".jpg").replace("-png", ".png").replace("-webp", ".webp")}`;
}

const coverImageUrl = getImageUrl(post.coverImage);

// SEO data
const seoData = {
    title: `${post.title} - ${post.category.title} - Blog`,
    description: post.excerpt,
    image: coverImageUrl || undefined,
    type: "article" as const,
};

// Custom Portable Text components
const components = {
    block: {
        h2: "h2",
        h3: "h3",
        h4: "h4",
        normal: "p",
        blockquote: "blockquote",
    },
    marks: {
        strong: "strong",
        em: "em",
        code: "code",
        link: ({ value, children }: any) => {
            return `<a href="${value?.href}" class="text-blue-400 hover:text-blue-300 underline" target="_blank" rel="noopener noreferrer">${children}</a>`;
        },
    },
};
---

<Layout {...seoData}>
    <div class="w-full lg:w-9/10 mx-auto p-4">
        <!-- Back Navigation -->
        <div class="mb-6">
            <a
                href={`/blog/${category}`}
                class="inline-flex items-center gap-2 px-4 py-2 bg-mochasurface hover:bg-mochasurfacelight border border-mochaborder rounded-lg text-mochawhite transition-colors"
            >
                <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                        d="M19 12H5M12 19L5 12L12 5"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"></path>
                </svg>
                Retour à {post.category.title}
            </a>
        </div>

        <article class="max-w-3xl mx-auto">
            <!-- Header -->
            <header class="mb-8">
                <div class="flex items-center gap-3 mb-4">
                    <span
                        class="px-3 py-1 bg-mochasurface border border-mochaborder rounded-md text-mochawhite/70 text-sm"
                    >
                        {post.category.title}
                    </span>
                    {
                        post.featured && (
                            <span class="px-2 py-1 bg-purple-500/20 text-purple-400 border border-purple-500/30 rounded-md text-xs">
                                En vedette
                            </span>
                        )
                    }
                </div>

                <h1
                    class="text-3xl md:text-4xl lg:text-5xl font-bold text-mochawhite mb-4 leading-tight"
                >
                    {post.title}
                </h1>

                <p class="text-mochawhite/70 text-lg mb-4">
                    {post.excerpt}
                </p>

                <time class="text-mochawhite/50 text-sm">
                    Publié le {formatDate(post.publishedAt)}
                </time>
            </header>

            <!-- Cover Image -->
            {
                coverImageUrl && (
                    <div class="mb-8 rounded-2xl overflow-hidden">
                        <img
                            src={coverImageUrl}
                            alt={post.title}
                            class="w-full h-auto"
                        />
                    </div>
                )
            }

            <!-- Content -->
            <div class="prose prose-invert prose-lg max-w-none">
                <PortableText value={post.content} />
            </div>
        </article>
    </div>
</Layout>

<style>
    /* Portable Text styling - using CSS variables for custom colors */
    .prose :global(h2) {
        font-size: 1.5rem;
        line-height: 2rem;
        font-weight: 700;
        color: #cdd6f4;
        margin-top: 2rem;
        margin-bottom: 1rem;
    }

    .prose :global(h3) {
        font-size: 1.25rem;
        line-height: 1.75rem;
        font-weight: 700;
        color: #cdd6f4;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .prose :global(h4) {
        font-size: 1.125rem;
        line-height: 1.75rem;
        font-weight: 600;
        color: #cdd6f4;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }

    .prose :global(p) {
        color: rgba(205, 214, 244, 0.8);
        line-height: 1.75;
        margin-bottom: 1rem;
    }

    .prose :global(blockquote) {
        border-left: 4px solid #313244;
        padding-left: 1rem;
        font-style: italic;
        color: rgba(205, 214, 244, 0.6);
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .prose :global(code) {
        background-color: #1e1e2e;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-family: ui-monospace, monospace;
        color: #cdd6f4;
    }

    .prose :global(pre) {
        background-color: #1e1e2e;
        border: 1px solid #313244;
        border-radius: 0.5rem;
        padding: 1rem;
        overflow-x: auto;
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .prose :global(pre code) {
        background-color: transparent;
        padding: 0;
    }

    .prose :global(ul) {
        list-style-type: disc;
        list-style-position: inside;
        color: rgba(205, 214, 244, 0.8);
        margin-bottom: 1rem;
    }

    .prose :global(ul li) {
        margin-bottom: 0.5rem;
    }

    .prose :global(ol) {
        list-style-type: decimal;
        list-style-position: inside;
        color: rgba(205, 214, 244, 0.8);
        margin-bottom: 1rem;
    }

    .prose :global(ol li) {
        margin-bottom: 0.5rem;
    }

    .prose :global(a) {
        color: #60a5fa;
        text-decoration: underline;
    }

    .prose :global(a:hover) {
        color: #93c5fd;
    }

    .prose :global(img) {
        border-radius: 0.5rem;
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .prose :global(figure) {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .prose :global(figcaption) {
        text-align: center;
        color: rgba(205, 214, 244, 0.5);
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
</style>
