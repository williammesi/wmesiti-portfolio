---
import Layout from "../../../layouts/Layout.astro";
import { sanityFetch, queries } from "@/lib/sanity";
import { safeAsync } from "@/utils/errorHandling";
import { verifyPassword, getAuthCookieHeader, isAuthenticated } from "@/lib/auth";
import type { BlogCategory } from "@/types/sanity";

// Disable prerendering
export const prerender = false;

// Get category slug from params
const { category } = Astro.params;

// Fetch category data (with password hash)
const categoryData = await safeAsync(
    () =>
        sanityFetch<BlogCategory | null>(queries.blogCategoryBySlug, {
            slug: category,
        }),
    null,
);

// If category doesn't exist, return 404
if (!categoryData) {
    return Astro.redirect("/404");
}

// If category is not protected, redirect to category page
if (!categoryData.isProtected) {
    return Astro.redirect(`/blog/${category}`);
}

// If already authenticated, redirect to category page
if (isAuthenticated(Astro.cookies, category as string)) {
    return Astro.redirect(`/blog/${category}`);
}

// Handle form submission
let error = "";
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const password = formData.get("password") as string;

        if (password && categoryData.passwordHash) {
            const isValid = await verifyPassword(password, categoryData.passwordHash);

            if (isValid) {
                // Use Response with Set-Cookie header for Vercel compatibility
                const cookieHeader = getAuthCookieHeader(category as string);
                return new Response(null, {
                    status: 302,
                    headers: {
                        "Location": `/blog/${category}`,
                        "Set-Cookie": cookieHeader,
                    },
                });
            } else {
                error = "Mot de passe incorrect";
            }
        } else {
            error = "Veuillez entrer un mot de passe";
        }
    } catch (e) {
        error = "Une erreur est survenue";
        console.error("[Auth] Login error:", e);
    }
}

// SEO data
const seoData = {
    title: `Connexion - ${categoryData.title} - Blog`,
    description: `Accès protégé à la catégorie ${categoryData.title}`,
    type: "website" as const,
    noindex: true,
};
---

<Layout {...seoData}>
    <div class="w-full lg:w-9/10 mx-auto p-4 min-h-[70vh] flex items-center justify-center">
        <div class="w-full max-w-md">
            <!-- Back Navigation -->
            <div class="mb-6">
                <a
                    href="/blog"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-mochasurface hover:bg-mochasurfacelight border border-mochaborder rounded-lg text-mochawhite transition-colors"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                    >
                        <path
                            d="M19 12H5M12 19L5 12L12 5"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"></path>
                    </svg>
                    Retour au blog
                </a>
            </div>

            <!-- Login Card -->
            <div class="bg-mochasurface border border-mochaborder rounded-2xl p-8">
                <!-- Lock Icon -->
                <div class="flex justify-center mb-6">
                    <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center">
                        <svg
                            width="32"
                            height="32"
                            viewBox="0 0 24 24"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                            class="text-yellow-400"
                        >
                            <rect
                                x="3"
                                y="11"
                                width="18"
                                height="11"
                                rx="2"
                                ry="2"
                                stroke="currentColor"
                                stroke-width="2"></rect>
                            <path
                                d="M7 11V7a5 5 0 0110 0v4"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"></path>
                        </svg>
                    </div>
                </div>

                <!-- Title -->
                <h1 class="text-2xl font-bold text-mochawhite text-center mb-2">
                    Contenu protégé
                </h1>
                <p class="text-mochawhite/60 text-center mb-6">
                    Entrez le mot de passe pour accéder à <span class="text-mochawhite font-medium">{categoryData.title}</span>
                </p>

                <!-- Error Message -->
                {error && (
                    <div class="mb-4 p-3 bg-red-500/20 border border-red-500/30 rounded-lg text-red-400 text-sm text-center">
                        {error}
                    </div>
                )}

                <!-- Login Form -->
                <form method="POST" class="space-y-4">
                    <div>
                        <label for="password" class="sr-only">Mot de passe</label>
                        <input
                            type="password"
                            id="password"
                            name="password"
                            placeholder="Mot de passe"
                            required
                            autofocus
                            class="w-full px-4 py-3 bg-mochablack border border-mochaborder rounded-lg text-mochawhite placeholder-mochawhite/40 focus:outline-none focus:border-mochawhite/50 transition-colors"
                        />
                    </div>

                    <button
                        type="submit"
                        class="w-full px-4 py-3 bg-mochawhite text-mochablack font-semibold rounded-lg hover:bg-mochawhite/90 transition-colors"
                    >
                        Accéder
                    </button>
                </form>
            </div>
        </div>
    </div>
</Layout>
